<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¸æ¸¬æ¨¡æ“¬å™¨ 2025 - æ±ºæˆ°ç”³è«‹ (æ•´åˆç‰ˆ)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f0f2f5; font-family: 'Microsoft JhengHei', sans-serif; padding-bottom: 80px; }
        .header-section { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px 0; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .stat-card { background: white; border-radius: 10px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: transform 0.2s; position: relative; }
        .stat-card:hover { transform: translateY(-2px); }
        .progress { height: 20px; margin-top: 10px; background-color: #e9ecef; }
        .progress-bar { font-weight: bold; line-height: 20px; transition: width 0.6s ease; }
        .energy-bar-container { position: sticky; top: 0; z-index: 100; background: rgba(255, 255, 255, 0.95); padding: 10px 0; border-bottom: 1px solid #ddd; backdrop-filter: blur(5px); }
        .log-area { height: 300px; overflow-y: auto; background: #333; color: #0f0; font-family: monospace; padding: 10px; border-radius: 5px; font-size: 0.9rem; }
        
        /* è¨“ç·´æŒ‰éˆ•æ¨£å¼ */
        .train-btn-group .btn { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 80px; }
        
        /* ç”³è«‹é é¢æ¨£å¼ */
        .school-list-item { cursor: pointer; transition: background 0.2s; }
        .school-list-item:hover { background-color: #f8f9fa; }
        .school-list-item.active { background-color: #e7f1ff; border-left: 4px solid #0d6efd; }
        .traffic-light { width: 15px; height: 15px; border-radius: 50%; display: inline-block; margin-right: 5px; border: 1px solid rgba(0,0,0,0.1); }
        .light-green { background-color: #28a745; box-shadow: 0 0 5px #28a745; }
        .light-yellow { background-color: #ffc107; box-shadow: 0 0 5px #ffc107; }
        .light-red { background-color: #dc3545; box-shadow: 0 0 5px #dc3545; }
        .dept-card { border-left: 5px solid #ddd; margin-bottom: 10px; }
        .bottom-cart { position: fixed; bottom: 0; left: 0; width: 100%; background: white; border-top: 1px solid #ccc; padding: 10px; z-index: 1050; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); display: none; }
    </style>
</head>
<body>

    <!-- éŠæˆ²ä¸»ç•«é¢ -->
    <div id="game-view">
        <div class="container-fluid energy-bar-container">
            <div class="container">
                <div class="row align-items-center">
                    <div class="col-4"><h5 class="m-0">ç¬¬ <span id="week-display">1</span> / 20 é€±</h5></div>
                    <div class="col-8">
                        <div class="d-flex align-items-center">
                            <span class="me-2">é«”åŠ›:</span>
                            <div class="progress flex-grow-1" style="height: 25px;">
                                <div id="energy-bar" class="progress-bar bg-success" style="width: 100%">100%</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="header-section text-center">
            <div class="container">
                <h1>ğŸ“ å­¸æ¸¬æ¨¡æ“¬å™¨ 2025</h1>
                <p>ç›®æ¨™ï¼šç·´å¥½å…­ç§‘ï¼Œæ’é20é€±ï¼Œä½¿ç”¨çœŸå¯¦å¤§å­¸è³‡æ–™ç”³è«‹ï¼</p>
            </div>
        </div>

        <div class="container">
            <div class="row">
                <!-- å·¦å´ï¼šç§‘ç›®åˆ—è¡¨ (ä¸»è¦æ“ä½œå€) -->
                <div class="col-lg-8 mb-4">
                    <h5 class="mb-3">ğŸ“š é»æ“Šä¸‹æ–¹æŒ‰éˆ•é–‹å§‹è¨“ç·´</h5>
                    <div class="row" id="subjects-container">
                        <!-- ç§‘ç›®å¡ç‰‡ç”± JS ç”Ÿæˆ -->
                    </div>
                </div>

                <!-- å³å´ï¼šè³‡è¨Šèˆ‡ç´€éŒ„ -->
                <div class="col-lg-4">
                    <div class="card mb-3">
                        <div class="card-header bg-dark text-white">
                            <h5 class="m-0">âš ï¸ éŠæˆ²è¦å‰‡</h5>
                        </div>
                        <div class="card-body small">
                            <ul>
                                <li>é»æ“Šå·¦å´ç§‘ç›®çš„<b>ã€Œè¨“ç·´ã€</b>æŒ‰éˆ•ï¼Œé¸æ“‡å¼·åº¦ã€‚</li>
                                <li><b>æ•¸å­¸A</b> å¾ˆé›£ï¼Œé€²æ­¥å¹…åº¦éš¨æ©Ÿ (0.1~0.5)ã€‚</li>
                                <li><b>è¶…é 2 é€±</b>æ²’è®€è©²ç§‘ï¼Œæœƒç”Ÿç–å€’é€€ã€‚</li>
                                <li><b>é«”åŠ›è€—ç›¡</b>æˆ–ä¸è¶³ä»¥è¨“ç·´æ™‚ï¼Œè‡ªå‹•é€²å…¥ä¸‹ä¸€é€±ã€‚</li>
                                <li>æ¯ 5 é€±æœƒæœ‰ä¸€æ¬¡æ¨¡æ“¬è€ƒã€‚</li>
                                <li>ç¬¬ 20 é€±çµæŸå¾Œé€²è¡Œå­¸æ¸¬èˆ‡å¿—é¡˜é¸å¡«ã€‚</li>
                            </ul>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header bg-secondary text-white">
                            <h5 class="m-0">ğŸ“¢ ç³»çµ±ç´€éŒ„</h5>
                        </div>
                        <div class="card-body p-0">
                            <div id="game-log" class="log-area"><div>ç³»çµ±åˆå§‹åŒ–ä¸­...</div></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ç”³è«‹å…¥å­¸ç•«é¢ (éš±è—) -->
    <div id="application-view" style="display: none;">
        <div class="header-section text-center bg-success">
            <div class="container">
                <h1>ğŸ« å¤§å­¸å€‹äººç”³è«‹å¿—é¡˜é¸å¡«</h1>
                <p>è³‡æ–™ä¾†æºï¼šå¤–éƒ¨ JSON æª” | è«‹ä¾ç…§ä½ çš„åˆ†æ•¸ï¼Œé¸æ“‡æœ€å¤š 6 å€‹å¿—é¡˜</p>
            </div>
        </div>

        <div class="container mb-5">
            <!-- æˆç¸¾çœ‹æ¿ -->
            <div class="card mb-4">
                <div class="card-header bg-dark text-white d-flex justify-content-between">
                    <span>ğŸ“ æˆ‘çš„æˆç¸¾å–®</span>
                    <span id="my-total-grade"></span>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered table-sm text-center mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>é …ç›®</th><th>åœ‹æ–‡</th><th>è‹±èª</th><th>æ•¸A</th><th>æ•¸B</th><th>ç¤¾æœƒ</th><th>è‡ªç„¶</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr id="score-row-raw"><td>åŸå§‹åˆ†</td><!-- JSå¡«å…¥ --></tr>
                                <tr id="score-row-rank" class="fw-bold text-primary"><td>ç´šåˆ†</td><!-- JSå¡«å…¥ --></tr>
                                <tr id="standards-row-top" class="text-danger small"><td>é ‚æ¨™</td><!-- JSå¡«å…¥ --></tr>
                                <tr id="standards-row-front" class="text-success small"><td>å‰æ¨™</td><!-- JSå¡«å…¥ --></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="row">
                <!-- å­¸æ ¡åˆ—è¡¨ -->
                <div class="col-md-4 mb-3">
                    <input type="text" class="form-control mb-2" id="school-search" placeholder="æœå°‹å­¸æ ¡..." oninput="filterSchools()">
                    <div class="list-group" id="school-list" style="height: 600px; overflow-y: auto;">
                        <div class="text-center p-3">æ­£åœ¨è®€å–å­¸æ ¡è³‡æ–™...</div>
                    </div>
                </div>

                <!-- ç§‘ç³»åˆ—è¡¨ -->
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header bg-white">
                            <h5 id="selected-school-name" class="m-0">è«‹é¸æ“‡å·¦å´å­¸æ ¡</h5>
                        </div>
                        <div class="card-body" id="dept-list" style="height: 600px; overflow-y: auto;">
                            <div class="text-center text-muted mt-5">
                                ğŸ‘ˆ é»æ“Šå·¦å´å­¸æ ¡æŸ¥çœ‹ç§‘ç³»
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- åº•éƒ¨é¸å¡«æ¸…å–® -->
        <div class="bottom-cart" id="application-cart" style="display: flex;">
            <div class="container d-flex justify-content-between align-items-center">
                <div>
                    <strong>å·²é¸å¿—é¡˜ï¼š</strong> <span id="cart-count" class="badge bg-primary">0</span> / 6
                    <div id="cart-items" class="small text-muted text-truncate" style="max-width: 600px;"></div>
                </div>
                <button class="btn btn-success" onclick="submitApplication()">ç¢ºèªé€å‡ºå¿—é¡˜</button>
            </div>
        </div>
    </div>

    <!-- çµæœ Modal -->
    <div class="modal fade" id="resultModal" data-bs-backdrop="static" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">ğŸ‰ æ”¾æ¦œçµæœ</h5>
                    <button type="button" class="btn-close" onclick="location.reload()"></button>
                </div>
                <div class="modal-body" id="result-body"></div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="location.reload()">é‡æ–°é–‹å§‹éŠæˆ²</button>
                </div>
            </div>
        </div>
    </div>

    <!-- è¨“ç·´é¸æ“‡ Modal (ä¿®æ”¹ç‰ˆï¼šé¸æ“‡å¼·åº¦) -->
    <div class="modal fade" id="trainingModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="training-modal-title">è¨“ç·´é¸æ“‡</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted text-center mb-3">è«‹é¸æ“‡æœ¬æ¬¡è¨“ç·´çš„å¼·åº¦ï¼š</p>
                    <div class="row g-2 train-btn-group">
                        <div class="col-6">
                            <button class="btn btn-outline-info w-100" onclick="confirmTraining(0)">
                                <strong>ğŸ“– ç¨å¾®ç¿»ç¿»</strong>
                                <small>é«”åŠ› -5% | æ•ˆæœ: ä½</small>
                            </button>
                        </div>
                        <div class="col-6">
                            <button class="btn btn-outline-primary w-100" onclick="confirmTraining(1)">
                                <strong>âœï¸ èªçœŸåˆ·é¡Œ</strong>
                                <small>é«”åŠ› -10% | æ•ˆæœ: ä¸­</small>
                            </button>
                        </div>
                        <div class="col-6">
                            <button class="btn btn-outline-warning w-100" onclick="confirmTraining(2)">
                                <strong>ğŸ§  è£œç¿’ç­è¡åˆº</strong>
                                <small>é«”åŠ› -15% | æ•ˆæœ: é«˜</small>
                            </button>
                        </div>
                        <div class="col-6">
                            <button class="btn btn-outline-danger w-100" onclick="confirmTraining(3)">
                                <strong>ğŸ”¥ ç‡ƒç‡’ç”Ÿå‘½</strong>
                                <small>é«”åŠ› -20% | æ•ˆæœ: æ¥µé™</small>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æˆç¸¾å–® Modal -->
    <div class="modal fade" id="scoreModal" data-bs-backdrop="static" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-warning"><h5 class="modal-title">æˆç¸¾å–®</h5></div>
                <div class="modal-body" id="score-content"></div>
                <div class="modal-footer"><button type="button" class="btn btn-primary" data-bs-dismiss="modal">ç¹¼çºŒ</button></div>
            </div>
        </div>
    </div>

    <!-- äº‹ä»¶ Modal -->
    <div class="modal fade" id="eventModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-danger">
                <div class="modal-header bg-danger text-white"><h5 class="modal-title">âš¡ çªç™¼äº‹ä»¶</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body text-center"><h4 id="event-title"></h4><p id="event-desc"></p></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // --- å…¨åŸŸè®Šæ•¸ ---
        const SUBJECTS_CONFIG = [
            { id: 'chi', name: 'åœ‹æ–‡', max: 100, color: 'bg-primary' },
            { id: 'eng', name: 'è‹±èª', max: 100, color: 'bg-info' },
            { id: 'mathA', name: 'æ•¸å­¸A', max: 100, color: 'bg-danger' },
            { id: 'mathB', name: 'æ•¸å­¸B', max: 100, color: 'bg-warning text-dark' },
            { id: 'soc', name: 'ç¤¾æœƒ', max: 144, color: 'bg-success' },
            { id: 'nat', name: 'è‡ªç„¶', max: 128, color: 'bg-secondary' }
        ];

        let GRADE_INTERVALS = { 'chi': 6.6, 'eng': 6.5, 'mathA': 5.8, 'mathB': 6.8, 'soc': 8.2, 'nat': 7.5 };
        let gameState = { week: 1, energy: 100, subjects: [], isGameOver: false };
        let playerResults = {}; // æœ€çµ‚æˆç¸¾ {id: {raw, grade}}
        let currentStandards = {}; // ç•¶å¹´åº¦äº”æ¨™
        let applicationCart = []; // è³¼ç‰©è»Š
        let ALL_SCHOOLS_DATA = []; // å¾ JSON è®€å–çš„è³‡æ–™
        
        // æš«å­˜è®Šæ•¸
        let currentSelectedSubjectIndex = -1;

        // --- 1. éŠæˆ²åˆå§‹åŒ– & å¤šæª”æ¡ˆè®€å– ---

        function log(msg, type = 'normal') {
            const logArea = document.getElementById('game-log');
            const div = document.createElement('div');
            div.innerText = `[W${gameState.week}] ${msg}`;
            if(type==='bad') div.style.color = '#ff6b6b';
            if(type==='good') div.style.color = '#51cf66';
            logArea.prepend(div);
        }

        async function initGame() {
            // è®€å– 3 å€‹ JSON æª”æ¡ˆ (ä¸ä½¿ç”¨ ./ é–‹é ­ä»¥é¿å…éƒ¨åˆ†ç’°å¢ƒå•é¡Œ)
            const files = ['schools_1.json', 'schools_2.json', 'schools_3.json'];
            
            try {
                const promises = files.map(url => fetch(url).then(res => {
                    if(!res.ok) throw new Error(`ç„¡æ³•è®€å– ${url}`);
                    return res.json();
                }));
                const results = await Promise.all(promises);
                ALL_SCHOOLS_DATA = results.flat();
                ALL_SCHOOLS_DATA.sort((a, b) => parseInt(a.id) - parseInt(b.id)); // æ’åº
                log(`æˆåŠŸè®€å– ${ALL_SCHOOLS_DATA.length} æ‰€å­¸æ ¡è³‡æ–™ï¼`, "good");
            } catch (error) {
                console.error(error);
                log("âš ï¸ è®€å–è³‡æ–™å¤±æ•—ï¼Œè«‹ç¢ºèªæª”æ¡ˆèˆ‡ index.html åœ¨åŒä¸€å±¤ã€‚", "bad");
                ALL_SCHOOLS_DATA = [{id: "000", name: "è³‡æ–™è®€å–å¤±æ•—", depts: []}];
            }

            // åˆå§‹åŒ–æ•¸å€¼
            gameState.week = 1;
            gameState.energy = 100;
            gameState.subjects = SUBJECTS_CONFIG.map(conf => {
                let startScore = clamp(randomNormal(conf.max * 0.45, conf.max * 0.15), 1, conf.max * 0.8);
                return { ...conf, score: startScore, lastTrained: 0 };
            });
            renderSubjects();
            updateUI();
        }

        // --- 2. éŠæˆ²æ ¸å¿ƒé‚è¼¯ ---
        function randomNormal(mean, stdDev) {
            let u = 0, v = 0;
            while(u === 0) u = Math.random(); 
            while(v === 0) v = Math.random();
            return Math.sqrt( -2.0 * Math.log( u ) ) * Math.cos( 2.0 * Math.PI * v ) * stdDev + mean;
        }
        function clamp(val, min, max) { return Math.min(Math.max(val, min), max); }

        function renderSubjects() {
            const container = document.getElementById('subjects-container');
            container.innerHTML = '';
            gameState.subjects.forEach((sub, index) => {
                const percent = (sub.score / sub.max) * 100;
                container.innerHTML += `
                    <div class="col-md-6">
                        <div class="stat-card">
                            <div class="subject-title mb-2">
                                ${sub.name}
                                <span>${sub.score.toFixed(1)} / ${sub.max}</span>
                            </div>
                            <div class="progress mb-3">
                                <div class="progress-bar ${sub.color}" style="width: ${percent}%"></div>
                            </div>
                            <button class="btn btn-outline-dark w-100" onclick="openTrainingOptions(${index})">
                                ğŸ‹ï¸ è¨“ç·´ ${sub.name}
                            </button>
                        </div>
                    </div>`;
            });
        }

        function updateUI() {
            document.getElementById('week-display').innerText = gameState.week;
            const bar = document.getElementById('energy-bar');
            bar.style.width = gameState.energy + '%';
            bar.innerText = Math.round(gameState.energy) + '%';
            bar.className = `progress-bar ${gameState.energy<=20 ? 'bg-danger':'bg-success'}`;
        }

        // --- ä¿®æ”¹å¾Œçš„è¨“ç·´é‚è¼¯ï¼šå…ˆé»ç§‘ç›®ï¼Œå†é¸å¼·åº¦ ---

        window.openTrainingOptions = function(subjectIndex) {
            if(gameState.energy < 5) { alert("é«”åŠ›ä¸è¶³ï¼Œè«‹ç›´æ¥é€²å…¥ä¸‹ä¸€é€±ï¼"); return; }
            
            currentSelectedSubjectIndex = subjectIndex;
            const sub = gameState.subjects[subjectIndex];
            
            // æ›´æ–° Modal æ¨™é¡Œ
            document.getElementById('training-modal-title').innerText = `è¨“ç·´ç§‘ç›®ï¼š${sub.name}`;
            
            // é–‹å•Ÿ Modal
            new bootstrap.Modal(document.getElementById('trainingModal')).show();
        }

        window.confirmTraining = function(intensityIndex) {
            // é—œé–‰ Modal
            bootstrap.Modal.getInstance(document.getElementById('trainingModal')).hide();

            const sub = gameState.subjects[currentSelectedSubjectIndex];
            const costs = [5, 10, 15, 20];
            const cost = costs[intensityIndex];

            // å†æ¬¡æª¢æŸ¥é«”åŠ›
            if(gameState.energy < cost) {
                alert("é«”åŠ›ä¸è¶³ä»¥é€²è¡Œæ­¤å¼·åº¦çš„è¨“ç·´ï¼");
                return;
            }
            
            // è¨ˆç®—æˆé•·
            let gain = (sub.id === 'mathA') ? (0.1 + Math.random()*0.4) : (cost/10.0 + (Math.random()*0.2-0.1));
            
            gameState.energy -= cost;
            sub.score += gain;
            sub.lastTrained = gameState.week;
            
            // æ»¿åˆ†æ‡²ç½°
            if(sub.score >= sub.max) {
                sub.score = sub.max;
                if(sub.id !== 'nat' && sub.id !== 'soc') {
                     let drop = Math.floor(Math.random()*10)+5;
                     sub.score -= drop;
                     log(`${sub.name} æ»¿åˆ†è‡ªæ»¿ï¼Œèƒ½åŠ›å€’é€€ ${drop}`, 'bad');
                }
            }

            // çªç™¼äº‹ä»¶
            if(Math.random() < 0.1) {
                 let target = gameState.subjects[Math.floor(Math.random()*6)];
                 let drop = Math.floor(Math.random()*5)+2;
                 target.score = Math.max(0, target.score - drop);
                 log(`çªç™¼äº‹ä»¶: ${target.name} -${drop}`, 'bad');
                 document.getElementById('event-title').innerText = "ç³Ÿç³•ï¼";
                 document.getElementById('event-desc').innerText = `ç™¼ç”Ÿäº†ä¸€äº›æ„å¤–ï¼Œå°è‡´ ${target.name} é€€æ­¥äº†ã€‚`;
                 new bootstrap.Modal(document.getElementById('eventModal')).show();
            }

            renderSubjects();
            updateUI();
            
            // é«”åŠ›éä½è‡ªå‹•ä¸‹ä¸€é€±
            if(gameState.energy < 5) setTimeout(nextWeek, 300);
        }

        function nextWeek() {
            if(gameState.week >= 20) { endGame(); return; }
            gameState.subjects.forEach(sub => {
                if(sub.lastTrained > 0 && (gameState.week - sub.lastTrained) >= 2) {
                    sub.score = Math.max(0, sub.score - 5);
                    log(`${sub.name} å¤ªä¹…æ²’è®€ç”Ÿç–äº† -5`, 'bad');
                }
            });
            if(gameState.week % 5 === 0) showScoreCard(false);
            gameState.week++;
            gameState.energy = 100;
            log(`é€²å…¥ç¬¬ ${gameState.week} é€±`, 'good');
            renderSubjects();
            updateUI();
        }

        // --- 3. è€ƒè©¦ç³»çµ± ---
        function calculateGrade(score, subjectId) {
            let grade = Math.round(score / GRADE_INTERVALS[subjectId]);
            return clamp(grade, 0, 15);
        }

        function generateFiveStandards() {
            let standards = {};
            SUBJECTS_CONFIG.forEach(sub => {
                let base = { "é ‚": 13, "å‰": 11, "å‡": 8, "å¾Œ": 5, "åº•": 3 };
                let shift = Math.floor(Math.random() * 3) - 1;
                standards[sub.id] = {
                    "é ‚": clamp(base["é ‚"] + shift, 12, 15),
                    "å‰": clamp(base["å‰"] + shift, 9, 12),
                    "å‡": clamp(base["å‡"] + shift, 6, 9),
                    "å¾Œ": clamp(base["å¾Œ"] + shift, 4, 7),
                    "åº•": clamp(base["åº•"] + shift, 1, 4)
                };
            });
            return standards;
        }

        function showScoreCard(isFinal) {
            let html = '<ul class="list-group">';
            let totalGrade = 0;
            if(isFinal) currentStandards = generateFiveStandards();

            gameState.subjects.forEach(sub => {
                let finalScore = sub.score;
                if(isFinal) {
                    let luck = clamp(randomNormal(25, 8), 1, 50);
                    finalScore = (sub.score * 0.5) + luck;
                    finalScore = Math.min(finalScore, sub.max);
                } else {
                    finalScore += (Math.random()*10 - 5);
                }
                let grade = calculateGrade(finalScore, sub.id);
                totalGrade += grade;
                if(isFinal) playerResults[sub.id] = { raw: finalScore.toFixed(1), grade: grade };

                html += `<li class="list-group-item d-flex justify-content-between align-items-center">
                    ${sub.name}
                    <span class="badge bg-primary rounded-pill">${grade} ç´šåˆ†</span>
                </li>`;
            });
            html += `</ul><div class="mt-3 text-end"><h5>ç¸½ç´šåˆ†: ${totalGrade}</h5></div>`;
            document.getElementById('score-content').innerHTML = html;
            
            const modalEl = document.getElementById('scoreModal');
            const modal = new bootstrap.Modal(modalEl);
            if(isFinal) {
                document.querySelector('#scoreModal .modal-footer button').onclick = startApplicationPhase;
                document.querySelector('#scoreModal .modal-footer button').innerText = "å‰å¾€å¿—é¡˜é¸å¡«";
            }
            modal.show();
        }

        function endGame() {
             new bootstrap.Modal(document.getElementById('eventModal')).hide();
             showScoreCard(true);
        }

        // --- 4. ç”³è«‹å…¥å­¸ç³»çµ± ---
        function startApplicationPhase() {
            bootstrap.Modal.getInstance(document.getElementById('scoreModal')).hide();
            document.getElementById('game-view').style.display = 'none';
            document.getElementById('application-view').style.display = 'block';
            renderMyScoreBoard();
            renderSchoolList();
        }

        function renderMyScoreBoard() {
            let htmlRaw = '<td>åŸå§‹åˆ†</td>', htmlRank = '<td>ç´šåˆ†</td>', htmlTop = '<td>é ‚æ¨™</td>', htmlFront = '<td>å‰æ¨™</td>';
            let totalG = 0;
            SUBJECTS_CONFIG.forEach(sub => {
                let r = playerResults[sub.id];
                let s = currentStandards[sub.id];
                totalG += r.grade;
                htmlRaw += `<td>${r.raw}</td>`;
                htmlRank += `<td>${r.grade}</td>`;
                htmlTop += `<td>${s["é ‚"]}</td>`;
                htmlFront += `<td>${s["å‰"]}</td>`;
            });
            document.getElementById('score-row-raw').innerHTML = htmlRaw;
            document.getElementById('score-row-rank').innerHTML = htmlRank;
            document.getElementById('standards-row-top').innerHTML = htmlTop;
            document.getElementById('standards-row-front').innerHTML = htmlFront;
            document.getElementById('my-total-grade').innerText = `ç¸½ç´šåˆ†: ${totalG}`;
        }

        function renderSchoolList(filterText = "") {
            const list = document.getElementById('school-list');
            list.innerHTML = '';
            
            const filteredSchools = ALL_SCHOOLS_DATA.filter(s => s.name.includes(filterText));

            filteredSchools.forEach((sch, idx) => {
                let item = document.createElement('a');
                item.className = 'list-group-item list-group-item-action school-list-item';
                item.innerText = sch.name;
                const realIndex = ALL_SCHOOLS_DATA.indexOf(sch);
                item.onclick = function() {
                    document.querySelectorAll('.school-list-item').forEach(i => i.classList.remove('active'));
                    item.classList.add('active');
                    selectSchool(realIndex);
                };
                list.appendChild(item);
            });
        }

        window.filterSchools = function() {
            const txt = document.getElementById('school-search').value;
            renderSchoolList(txt);
        }

        function selectSchool(index) {
            const school = ALL_SCHOOLS_DATA[index];
            document.getElementById('selected-school-name').innerText = school.name;
            const container = document.getElementById('dept-list');
            container.innerHTML = '';

            school.depts.forEach(dept => {
                const analysis = analyzeProbability(dept);
                
                let reqText = [];
                for(let sub in dept.req) reqText.push(`${SUBJECTS_CONFIG.find(s=>s.id==sub).name}${dept.req[sub]}`);
                let weightText = dept.weight.map(w=>SUBJECTS_CONFIG.find(s=>s.id==w).name).join('+');
                
                let lightClass = analysis.status === 'safe' ? 'light-green' : (analysis.status === 'risky' ? 'light-yellow' : 'light-red');
                let btnState = applicationCart.length >= 6 ? 'disabled' : '';
                let isInCart = applicationCart.some(item => item.schoolName === school.name && item.deptName === dept.name);
                
                let btnHtml = isInCart 
                    ? `<button class="btn btn-secondary btn-sm" disabled>å·²åŠ å…¥</button>`
                    : `<button class="btn btn-outline-primary btn-sm" onclick="addToCart('${school.name}', '${dept.name}')" ${btnState}>åŠ å…¥å¿—é¡˜</button>`;

                container.innerHTML += `
                    <div class="card dept-card p-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1 fw-bold">${dept.name}</h6>
                                <small class="text-muted">æª¢å®š: ${reqText.join(', ')}</small><br>
                                <small class="text-muted">æ¡è¨ˆ: ${weightText}</small>
                            </div>
                            <div class="text-end">
                                <div class="mb-1" title="éŒ„å–æ©Ÿç‡"><span class="traffic-light ${lightClass}"></span><span class="small text-muted">${analysis.msg}</span></div>
                                ${btnHtml}
                            </div>
                        </div>
                    </div>`;
            });
        }

        function analyzeProbability(dept) {
            for(let subId in dept.req) {
                let requiredRank = currentStandards[subId][dept.req[subId]];
                let myRank = playerResults[subId].grade;
                if(myRank < requiredRank) return { status: 'fail', msg: 'æœªé”æ¨™' };
            }
            let myScore = 0;
            dept.weight.forEach(w => myScore += playerResults[w].grade);
            let diff = dept.baseScore; 
            if(myScore >= diff + 2) return { status: 'safe', msg: 'ç©©ç©©çš„' };
            if(myScore >= diff - 2) return { status: 'risky', msg: 'æœ‰æ©Ÿæœƒ' };
            return { status: 'fail', msg: 'å±éšª' };
        }

        window.addToCart = function(sName, dName) {
            if(applicationCart.length >= 6) return;
            let school = ALL_SCHOOLS_DATA.find(s => s.name === sName);
            let dept = school.depts.find(d => d.name === dName);
            applicationCart.push({ schoolName: sName, deptName: dName, deptData: dept });
            updateCartUI();
            let currentSchool = document.getElementById('selected-school-name').innerText;
            if(currentSchool === sName) selectSchool(ALL_SCHOOLS_DATA.indexOf(school));
        }

        function updateCartUI() {
            const cartBar = document.getElementById('application-cart');
            const countSpan = document.getElementById('cart-count');
            const itemsDiv = document.getElementById('cart-items');
            if(applicationCart.length > 0) cartBar.style.display = 'flex';
            countSpan.innerText = applicationCart.length;
            itemsDiv.innerHTML = applicationCart.map((item, idx) => 
                `<span class="badge bg-secondary me-1" style="cursor:pointer" onclick="removeFromCart(${idx})">${item.schoolName.substring(0,2)}..${item.deptName}âœ•</span>`
            ).join('');
        }

        window.removeFromCart = function(idx) {
            applicationCart.splice(idx, 1);
            updateCartUI();
            let currentSchool = document.getElementById('selected-school-name').innerText;
            let sIdx = ALL_SCHOOLS_DATA.findIndex(s => s.name === currentSchool);
            if(sIdx !== -1) selectSchool(sIdx);
        }

        window.submitApplication = function() {
            if(applicationCart.length === 0) { alert("è«‹è‡³å°‘é¸ä¸€å€‹å¿—é¡˜ï¼"); return; }
            let resultHtml = '<div class="list-group">';
            applicationCart.forEach(item => {
                const dept = item.deptData;
                let passThreshold = true;
                let failReason = "";
                for(let subId in dept.req) {
                    if(playerResults[subId].grade < currentStandards[subId][dept.req[subId]]) {
                        passThreshold = false;
                        failReason = `${SUBJECTS_CONFIG.find(s=>s.id==subId).name}æ¨™æœªé”`;
                        break;
                    }
                }
                let myWeightedRawScore = 0;
                dept.weight.forEach(w => myWeightedRawScore += parseFloat(playerResults[w].raw));
                let estimatedRawCutoff = dept.baseScore * 6.6 * (0.95 + Math.random()*0.1);

                let isAdmitted = false;
                if(passThreshold && myWeightedRawScore >= estimatedRawCutoff) isAdmitted = true;

                let statusBadge = isAdmitted ? `<span class="badge bg-success">éŒ„å–</span>` : `<span class="badge bg-secondary">æœªéŒ„å–</span>`;
                let detail = passThreshold 
                    ? (isAdmitted ? `ç”„è©¦ç¸½åˆ† ${myWeightedRawScore.toFixed(1)} æˆåŠŸéŒ„å–ï¼` : `ç”„è©¦ç¸½åˆ† ${myWeightedRawScore.toFixed(1)} æœªé”éŒ„å–æ¨™æº–`)
                    : `ç¬¬ä¸€éšæ®µç¯©é¸æœªé€šé (${failReason})`;

                resultHtml += `
                    <div class="list-group-item">
                        <div class="d-flex w-100 justify-content-between">
                            <h5 class="mb-1">${item.schoolName} - ${item.deptName}</h5>
                            ${statusBadge}
                        </div>
                        <p class="mb-1 small text-muted">${detail}</p>
                    </div>`;
            });
            resultHtml += '</div>';
            document.getElementById('result-body').innerHTML = resultHtml;
            new bootstrap.Modal(document.getElementById('resultModal')).show();
        }

        initGame();
    </script>
</body>
</html>
