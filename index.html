<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¸æ¸¬æ¨¡æ“¬å™¨ - æ±ºæˆ°ç”³è«‹ (å®Œæ•´è³‡æ–™ç‰ˆ)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f0f2f5; font-family: 'Microsoft JhengHei', sans-serif; padding-bottom: 180px; /* å¢åŠ åº•éƒ¨ç©ºé–“çµ¦è³¼ç‰©è»Š */ }
        .header-section { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px 0; margin-bottom: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        
        .stat-card { background: white; border-radius: 8px; padding: 10px; margin-bottom: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .subject-title { font-size: 1rem; font-weight: bold; display: flex; justify-content: space-between; }
        .progress { height: 15px; margin-top: 5px; background-color: #e9ecef; }
        .progress-bar { font-size: 0.8rem; line-height: 15px; transition: width 0.3s ease; }
        
        .energy-bar-container { position: sticky; top: 0; z-index: 100; background: rgba(255, 255, 255, 0.95); padding: 8px 0; border-bottom: 1px solid #ddd; backdrop-filter: blur(5px); }
        
        /* å››æ ¼æ§åˆ¶å° */
        .control-panel { margin-top: 20px; }
        .method-card { border: none; height: 100%; transition: transform 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .method-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.15); }
        .method-header { padding: 10px; text-align: center; color: white; font-weight: bold; border-radius: 8px 8px 0 0; }
        .method-body { padding: 10px; background: white; border-radius: 0 0 8px 8px; }
        
        .subject-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; }
        .btn-subject { font-size: 0.85rem; padding: 5px 0; border: 1px solid #eee; background: #fff; transition: all 0.1s; }
        .btn-subject:hover { background: #f8f9fa; filter: brightness(0.95); }
        .btn-subject:active { transform: scale(0.95); }

        .bg-method-0 { background-color: #17a2b8; }
        .bg-method-1 { background-color: #0d6efd; }
        .bg-method-2 { background-color: #ffc107; color: #000; }
        .bg-method-3 { background-color: #dc3545; }

        /* ç”³è«‹é é¢ */
        .school-list-item { cursor: pointer; transition: background 0.2s; }
        .school-list-item:hover { background-color: #f8f9fa; }
        .school-list-item.active { background-color: #e7f1ff; border-left: 4px solid #0d6efd; }
        
        .traffic-light { width: 12px; height: 12px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .light-green { background-color: #28a745; box-shadow: 0 0 4px #28a745; }
        .light-yellow { background-color: #ffc107; box-shadow: 0 0 4px #ffc107; }
        .light-red { background-color: #dc3545; box-shadow: 0 0 4px #dc3545; }
        
        .dept-card { border-left: 4px solid #ddd; margin-bottom: 8px; font-size: 0.9rem; }
        
        /* åº•éƒ¨è³¼ç‰©è»Šæ¨£å¼å„ªåŒ– */
        .bottom-cart { 
            position: fixed; bottom: 0; left: 0; width: 100%; 
            background: white; border-top: 1px solid #ccc; 
            padding: 15px; z-index: 1050; display: none; 
            box-shadow: 0 -4px 10px rgba(0,0,0,0.1);
            max-height: 250px;
        }
        .cart-list-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            max-height: 120px;
            overflow-y: auto;
            margin-bottom: 10px;
            width: 100%;
        }
        .cart-item-badge {
            background-color: #e9ecef;
            border: 1px solid #ced4da;
            color: #333;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
        }
        .cart-item-badge .btn-close {
            margin-left: 8px;
            font-size: 0.7rem;
        }
        
        .log-area { max-height: 100px; overflow-y: auto; background: #333; color: #0f0; font-family: monospace; padding: 5px; border-radius: 5px; font-size: 0.8rem; margin-top: 10px; }

        .score-table th, .score-table td { text-align: center; vertical-align: middle; }
    </style>
</head>
<body>

    <!-- éŠæˆ²ä¸»ç•«é¢ -->
    <div id="game-view">
        <div class="container-fluid energy-bar-container">
            <div class="container">
                <div class="row align-items-center">
                    <div class="col-4"><h5 class="m-0">ç¬¬ <span id="week-display">1</span> / 20 é€±</h5></div>
                    <div class="col-8">
                        <div class="d-flex align-items-center">
                            <span class="me-2">é«”åŠ›:</span>
                            <div class="progress flex-grow-1" style="height: 20px;">
                                <div id="energy-bar" class="progress-bar bg-success" style="width: 100%">100%</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="header-section text-center">
            <div class="container">
                <h2 class="m-0">ğŸ“ å­¸æ¸¬æ¨¡æ“¬å™¨ </h2>
            </div>
        </div>

        <div class="container">
            <div class="row" id="subjects-container"></div>
            
            <div class="row">
                <div class="col-12">
                    <div id="game-log" class="log-area"><div>éŠæˆ²é–‹å§‹ï¼è«‹é¸æ“‡ä¸‹æ–¹çš„è¨“ç·´æ–¹å¼...</div></div>
                </div>
            </div>

            <div class="row control-panel g-3">
                <div class="col-12 text-center mb-1"><h5>ğŸ‘‡ é¸æ“‡è¨“ç·´æ–¹å¼èˆ‡ç§‘ç›® (ç›´æ¥é»æ“Š)</h5></div>
                
                <div class="col-lg-3 col-6">
                    <div class="method-card">
                        <div class="method-header bg-method-0">ğŸ“– ç¨å¾®ç¿»ç¿»<br><small style="font-weight:normal; font-size:0.8rem">-5% | æ•ˆæœ ä½</small></div>
                        <div class="method-body"><div class="subject-grid" id="grid-0"></div></div>
                    </div>
                </div>
                <div class="col-lg-3 col-6">
                    <div class="method-card">
                        <div class="method-header bg-method-1">âœï¸ èªçœŸåˆ·é¡Œ<br><small style="font-weight:normal; font-size:0.8rem">-10% | æ•ˆæœ ä¸­</small></div>
                        <div class="method-body"><div class="subject-grid" id="grid-1"></div></div>
                    </div>
                </div>
                <div class="col-lg-3 col-6">
                    <div class="method-card">
                        <div class="method-header bg-method-2">ğŸ§  è£œç¿’ç­è¡åˆº<br><small style="font-weight:normal; font-size:0.8rem">-15% | æ•ˆæœ é«˜</small></div>
                        <div class="method-body"><div class="subject-grid" id="grid-2"></div></div>
                    </div>
                </div>
                <div class="col-lg-3 col-6">
                    <div class="method-card">
                        <div class="method-header bg-method-3">ğŸ”¥ ç‡ƒç‡’ç”Ÿå‘½<br><small style="font-weight:normal; font-size:0.8rem">-20% | æ•ˆæœ æ¥µé™</small></div>
                        <div class="method-body"><div class="subject-grid" id="grid-3"></div></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ç”³è«‹å…¥å­¸ç•«é¢ -->
    <div id="application-view" style="display: none;">
        <div class="header-section text-center bg-success">
            <div class="container">
                <h2>ğŸ« å¿—é¡˜é¸å¡«</h2>
                <p class="m-0">ç”„è©¦ç¸½åˆ†ç‚ºæ¡è¨ˆç§‘ç›®ç´šåˆ†ç¸½å’Œ</p>
            </div>
        </div>

        <div class="container mb-5">
            <div class="card mb-3">
                <div class="card-header bg-dark text-white d-flex justify-content-between py-2">
                    <span class="small">ğŸ“ æˆç¸¾å–®</span>
                    <span id="my-total-grade" class="small fw-bold"></span>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-bordered table-sm text-center mb-0" style="font-size: 0.9rem;">
                            <thead class="table-light"><tr><th>é …ç›®</th><th>åœ‹</th><th>è‹±</th><th>æ•¸A</th><th>æ•¸B</th><th>ç¤¾</th><th>è‡ª</th></tr></thead>
                            <tbody>
                                <tr id="score-row-raw"><td>åŸå§‹</td></tr>
                                <tr id="score-row-rank" class="fw-bold text-primary"><td>ç´šåˆ†</td></tr>
                                <tr id="standards-row-top" class="text-danger small"><td>é ‚æ¨™</td></tr>
                                <tr id="standards-row-front" class="text-success small"><td>å‰æ¨™</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-4 mb-3">
                    <input type="text" class="form-control form-control-sm mb-2" id="school-search" placeholder="æœå°‹å­¸æ ¡..." oninput="filterSchools()">
                    <div class="list-group" id="school-list" style="height: 500px; overflow-y: auto;">
                        <div class="text-center p-3 small">è®€å–è³‡æ–™ä¸­...</div>
                    </div>
                </div>
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header bg-white py-2"><strong id="selected-school-name">è«‹é¸æ“‡å­¸æ ¡</strong></div>
                        <div class="card-body p-2" id="dept-list" style="height: 500px; overflow-y: auto;">
                            <div class="text-center text-muted mt-5 small">ğŸ‘ˆ é»æ“Šå·¦å´å­¸æ ¡æŸ¥çœ‹ç§‘ç³»</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- åº•éƒ¨å¿—é¡˜æ¸…å–® (ä¿®æ”¹ç‰ˆ) -->
        <div class="bottom-cart flex-column" id="application-cart">
            <div class="container">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <strong>å·²é¸å¿—é¡˜æ¸…å–® (<span id="cart-count">0</span>/6)</strong>
                    <button class="btn btn-success btn-sm" onclick="submitApplication()">ç¢ºèªé€å‡ºå¿—é¡˜</button>
                </div>
                <div id="cart-items" class="cart-list-container">
                    <!-- å¿—é¡˜é …ç›®å°‡åˆ—åœ¨é€™è£¡ -->
                </div>
            </div>
        </div>
    </div>

    <!-- çµæœ Modal -->
    <div class="modal fade" id="resultModal" data-bs-backdrop="static" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">ğŸ‰ æ”¾æ¦œçµæœ</h5>
                    <button type="button" class="btn-close" onclick="location.reload()"></button>
                </div>
                <div class="modal-body" id="result-body"></div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="location.reload()">é‡ç©</button>
                </div>
            </div>
        </div>
    </div>

    <!-- æˆç¸¾å–® Modal -->
    <div class="modal fade" id="scoreModal" data-bs-backdrop="static" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-warning py-2"><h5 class="modal-title" id="score-modal-title">æˆç¸¾å–®</h5></div>
                <div class="modal-body p-0">
                    <table class="table table-striped mb-0 score-table">
                        <thead class="table-light">
                            <tr>
                                <th>ç§‘ç›®</th>
                                <th>åŸå§‹åˆ†æ•¸</th>
                                <th>ç´šè·</th>
                                <th>ç´šåˆ†</th>
                            </tr>
                        </thead>
                        <tbody id="score-table-body">
                            <!-- JS ç”Ÿæˆ -->
                        </tbody>
                    </table>
                    <div class="p-2 text-end border-top">
                        <h5 class="m-0" id="score-total-display">ç¸½ç´šåˆ†: 0</h5>
                    </div>
                </div>
                <div class="modal-footer py-1"><button type="button" class="btn btn-primary btn-sm" id="score-confirm-btn" data-bs-dismiss="modal">ç¹¼çºŒ</button></div>
            </div>
        </div>
    </div>

    <!-- äº‹ä»¶ Modal -->
    <div class="modal fade" id="eventModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-danger">
                <div class="modal-header bg-danger text-white py-2"><h5 class="modal-title">âš¡ çªç™¼äº‹ä»¶</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body text-center"><h4 id="event-title"></h4><p id="event-desc"></p></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const SUBJECTS_CONFIG = [
            { id: 'chi', name: 'åœ‹æ–‡', max: 100, color: 'bg-primary' },
            { id: 'eng', name: 'è‹±èª', max: 100, color: 'bg-info' },
            { id: 'mathA', name: 'æ•¸å­¸A', max: 100, color: 'bg-danger' },
            { id: 'mathB', name: 'æ•¸å­¸B', max: 100, color: 'bg-warning text-dark' },
            { id: 'soc', name: 'ç¤¾æœƒ', max: 144, color: 'bg-success' },
            { id: 'nat', name: 'è‡ªç„¶', max: 128, color: 'bg-secondary' }
        ];

        let GRADE_INTERVALS = { 'chi': 6.6, 'eng': 6.5, 'mathA': 5.8, 'mathB': 6.8, 'soc': 8.2, 'nat': 7.5 };
        
        let gameState = { week: 1, energy: 100, subjects: [], isGameOver: false };
        let playerResults = {}; 
        let currentStandards = {}; 
        let applicationCart = [];
        let ALL_SCHOOLS_DATA = [];
        let lastEventSubjectId = null;

        function log(msg, type = 'normal') {
            const logArea = document.getElementById('game-log');
            const div = document.createElement('div');
            div.innerText = `[W${gameState.week}] ${msg}`;
            if(type==='bad') div.style.color = '#ff6b6b';
            if(type==='good') div.style.color = '#51cf66';
            logArea.prepend(div);
        }

        async function initGame() {
            // è¨­å®šç¤¾æœƒç§‘ç´šè· (6~8 éš¨æ©Ÿ)
            GRADE_INTERVALS['soc'] = parseFloat((6 + Math.random() * 2).toFixed(2));
            console.log("æœ¬å±€ç¤¾æœƒç§‘ç´šè·:", GRADE_INTERVALS['soc']);

            const files = ['schools_1.json', 'schools_2.json', 'schools_3.json'];
            try {
                const promises = files.map(url => fetch(url).then(res => {
                    if(!res.ok) throw new Error("File error");
                    return res.json();
                }));
                const results = await Promise.all(promises);
                ALL_SCHOOLS_DATA = results.flat().sort((a,b)=>parseInt(a.id)-parseInt(b.id));
                log(`è³‡æ–™åº«è¼‰å…¥å®Œæˆï¼š${ALL_SCHOOLS_DATA.length} æ‰€å­¸æ ¡`, "good");
            } catch (e) {
                console.error(e);
                log("âš ï¸ è³‡æ–™è®€å–å¤±æ•—ï¼Œè«‹ç¢ºèª JSON æª”æ¡ˆã€‚", "bad");
                ALL_SCHOOLS_DATA = [{id:"000",name:"è®€å–å¤±æ•—",depts:[]}];
            }

            gameState.week = 1;
            gameState.energy = 100;
            gameState.subjects = SUBJECTS_CONFIG.map(conf => {
                let startScore = clamp(randomNormal(conf.max * 0.45, conf.max * 0.15), 1, conf.max * 0.8);
                return { ...conf, score: startScore, lastTrained: 0 };
            });

            renderSubjects();
            renderControlPanel();
            updateUI();
        }

        function renderSubjects() {
            const container = document.getElementById('subjects-container');
            container.innerHTML = '';
            gameState.subjects.forEach(sub => {
                const percent = (sub.score / sub.max) * 100;
                container.innerHTML += `
                    <div class="col-md-4 col-6">
                        <div class="stat-card">
                            <div class="subject-title">
                                ${sub.name} <span class="text-muted" style="font-size:0.9em">${sub.score.toFixed(1)}</span>
                            </div>
                            <div class="progress">
                                <div class="progress-bar ${sub.color}" style="width: ${percent}%"></div>
                            </div>
                        </div>
                    </div>`;
            });
        }

        function renderControlPanel() {
            for(let i=0; i<4; i++) {
                const grid = document.getElementById(`grid-${i}`);
                grid.innerHTML = '';
                gameState.subjects.forEach((sub, subIdx) => {
                    const btn = document.createElement('button');
                    btn.className = `btn btn-subject`;
                    btn.innerText = sub.name;
                    btn.onclick = () => doTraining(subIdx, i);
                    grid.appendChild(btn);
                });
            }
        }

        function updateUI() {
            document.getElementById('week-display').innerText = gameState.week;
            const bar = document.getElementById('energy-bar');
            bar.style.width = gameState.energy + '%';
            bar.innerText = Math.round(gameState.energy) + '%';
            bar.className = `progress-bar ${gameState.energy<=20 ? 'bg-danger':'bg-success'}`;
        }

        function randomNormal(mean, stdDev) {
            let u=0, v=0;
            while(u===0) u=Math.random(); 
            while(v===0) v=Math.random();
            return Math.sqrt(-2.0*Math.log(u)) * Math.cos(2.0*Math.PI*v) * stdDev + mean;
        }
        function clamp(val, min, max) { return Math.min(Math.max(val, min), max); }

        window.doTraining = function(subIdx, intensityIndex) {
            const sub = gameState.subjects[subIdx];
            const costs = [5, 10, 15, 20];
            const cost = costs[intensityIndex];

            if(gameState.energy < cost) {
                alert("é«”åŠ›ä¸è¶³ï¼");
                if(gameState.energy < 5) nextWeek();
                return;
            }

            let gain = (sub.id === 'mathA') ? (0.1 + Math.random()*0.4) : (cost/10.0 + (Math.random()*0.2-0.1));
            
            gameState.energy -= cost;
            sub.score += gain;
            sub.lastTrained = gameState.week;

            if(sub.score >= sub.max) {
                sub.score = sub.max;
                if(sub.id !== 'nat' && sub.id !== 'soc') {
                    let drop = Math.floor(Math.random()*10)+5;
                    sub.score -= drop;
                    log(`${sub.name} è‡ªæ»¿ -${drop}`, 'bad');
                }
            }

            if(Math.random() < 0.08) {
                let possibleTargets = gameState.subjects.filter(s => s.id !== lastEventSubjectId);
                if(possibleTargets.length === 0) possibleTargets = gameState.subjects;
                
                let target = possibleTargets[Math.floor(Math.random() * possibleTargets.length)];
                lastEventSubjectId = target.id;

                let drop;
                if (target.id === 'mathB') {
                    // æ•¸B æ¯”è¼ƒç°¡å–®ï¼Œé‹æ°£ä¸å¥½æ™‚åªæ‰£ 1~3 åˆ†
                    drop = Math.floor(Math.random() * 3) + 1;
                } else {
                    // å…¶ä»–ç§‘ç›®ç¶­æŒåŸæœ¬è¨­å®šï¼Œæ‰£ 2~6 åˆ†
                    drop = Math.floor(Math.random() * 5) + 2;
                }
                target.score = Math.max(0, target.score - drop);
                log(`çªç™¼: ${target.name} -${drop}`, 'bad');
                document.getElementById('event-title').innerText = "çªç™¼ç‹€æ³";
                document.getElementById('event-desc').innerText = `æ„å¤–ç™¼ç”Ÿï¼${target.name} é€€æ­¥äº† ${drop} åˆ†ã€‚`;
                new bootstrap.Modal(document.getElementById('eventModal')).show();
            }

            renderSubjects();
            updateUI();
            if(gameState.energy < 5) setTimeout(nextWeek, 300);
        }

        function nextWeek() {
            if(gameState.week >= 20) { endGame(); return; }
            
            gameState.subjects.forEach(sub => {
                if(sub.lastTrained > 0 && (gameState.week - sub.lastTrained) >= 2) {
                    sub.score = Math.max(0, sub.score - 5);
                    log(`${sub.name} ç”Ÿç– -5`, 'bad');
                }
            });

            if(gameState.week % 5 === 0) showScoreCard(false);

            gameState.week++;
            gameState.energy = 100;
            log(`=== ç¬¬ ${gameState.week} é€± ===`, 'normal');
            renderSubjects();
            updateUI();
        }

        function calculateGrade(score, sid) {
            return clamp(Math.round(score / GRADE_INTERVALS[sid]), 0, 15);
        }

        function generateFiveStandards() {
            let stds = {};
            SUBJECTS_CONFIG.forEach(sub => {
                let base = { "é ‚": 13, "å‰": 11, "å‡": 8, "å¾Œ": 5, "åº•": 3 };
                let shift = Math.floor(Math.random()*3)-1;
                stds[sub.id] = {
                    "é ‚": clamp(base["é ‚"]+shift,12,15), "å‰": clamp(base["å‰"]+shift,9,12),
                    "å‡": clamp(base["å‡"]+shift,6,9), "å¾Œ": clamp(base["å¾Œ"]+shift,4,7),
                    "åº•": clamp(base["åº•"]+shift,1,4)
                };
            });
            return stds;
        }

        function showScoreCard(isFinal) {
            let totalGrade = 0;
            let tbody = document.getElementById('score-table-body');
            tbody.innerHTML = '';
            
            if(isFinal) currentStandards = generateFiveStandards();

            gameState.subjects.forEach(sub => {
                let finalScore = sub.score;
                if(isFinal) {
                    let luck = clamp(randomNormal(25, 8), 1, 50);
                    finalScore = (sub.score * 0.5) + luck;
                    finalScore = Math.min(finalScore, sub.max);
                } else {
                    finalScore += (Math.random()*10 - 5);
                    finalScore = Math.max(0, Math.min(finalScore, sub.max));
                }

                let interval = GRADE_INTERVALS[sub.id];
                let grade = calculateGrade(finalScore, sub.id);
                totalGrade += grade;

                if(isFinal) {
                    playerResults[sub.id] = { raw: finalScore.toFixed(2), grade: grade, interval: interval };
                }

                let row = `
                    <tr>
                        <td class="fw-bold">${sub.name}</td>
                        <td>${finalScore.toFixed(2)}</td>
                        <td>${interval}</td>
                        <td class="fw-bold text-primary">${grade}</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });

            document.getElementById('score-total-display').innerText = `ç¸½ç´šåˆ†: ${totalGrade}`;
            
            let modalEl = document.getElementById('scoreModal');
            let btn = document.getElementById('score-confirm-btn');
            let title = document.getElementById('score-modal-title');

            if(isFinal) {
                title.innerText = "ğŸ† 114å­¸å¹´åº¦å­¸æ¸¬æˆç¸¾å–®";
                btn.innerText = "å‰å¾€å¿—é¡˜é¸å¡«";
                btn.onclick = () => {
                    bootstrap.Modal.getInstance(modalEl).hide();
                    document.getElementById('game-view').style.display = 'none';
                    document.getElementById('application-view').style.display = 'block';
                    renderMyScoreBoard();
                    renderSchoolList();
                };
            } else {
                title.innerText = `ç¬¬ ${gameState.week} é€± - æ¨¡æ“¬è€ƒ`;
                btn.innerText = "ç¹¼çºŒåŠªåŠ›";
                btn.onclick = () => bootstrap.Modal.getInstance(modalEl).hide();
            }
            new bootstrap.Modal(modalEl).show();
        }

        function endGame() {
             new bootstrap.Modal(document.getElementById('eventModal')).hide();
             showScoreCard(true);
        }

        function renderMyScoreBoard() {
            let htmlRaw='<td>åŸå§‹</td>', htmlRank='<td>ç´šåˆ†</td>', htmlTop='<td>é ‚æ¨™</td>', htmlFront='<td>å‰æ¨™</td>';
            let total=0;
            SUBJECTS_CONFIG.forEach(sub => {
                let r = playerResults[sub.id];
                let s = currentStandards[sub.id];
                total += r.grade;
                htmlRaw += `<td>${r.raw}</td>`;
                htmlRank += `<td>${r.grade}</td>`;
                htmlTop += `<td>${s["é ‚"]}</td>`;
                htmlFront += `<td>${s["å‰"]}</td>`;
            });
            document.getElementById('score-row-raw').innerHTML = htmlRaw;
            document.getElementById('score-row-rank').innerHTML = htmlRank;
            document.getElementById('standards-row-top').innerHTML = htmlTop;
            document.getElementById('standards-row-front').innerHTML = htmlFront;
            document.getElementById('my-total-grade').innerText = `ç¸½ç´šåˆ†: ${total}`;
        }

        function renderSchoolList(filterText = "") {
            const list = document.getElementById('school-list');
            list.innerHTML = '';
            const filtered = ALL_SCHOOLS_DATA.filter(s => s.name.includes(filterText));
            filtered.forEach((sch) => {
                let item = document.createElement('div');
                item.className = 'list-group-item school-list-item px-2 py-1';
                item.innerText = sch.name;
                const realIdx = ALL_SCHOOLS_DATA.indexOf(sch);
                item.onclick = function() {
                    document.querySelectorAll('.school-list-item').forEach(i=>i.classList.remove('active'));
                    item.classList.add('active');
                    selectSchool(realIdx);
                };
                list.appendChild(item);
            });
        }

        window.filterSchools = function() {
            renderSchoolList(document.getElementById('school-search').value);
        }

        function selectSchool(idx) {
            const sch = ALL_SCHOOLS_DATA[idx];
            document.getElementById('selected-school-name').innerText = sch.name;
            const container = document.getElementById('dept-list');
            container.innerHTML = '';
            
            sch.depts.forEach(dept => {
                const ana = analyzeProbability(dept);
                let reqText = Object.keys(dept.req).map(k=>`${SUBJECTS_CONFIG.find(s=>s.id==k).name}${dept.req[k]}`).join(',');
                let wText = dept.weight.map(w=>SUBJECTS_CONFIG.find(s=>s.id==w).name).join('+');
                let light = ana.status==='safe'?'light-green':(ana.status==='risky'?'light-yellow':'light-red');
                let inCart = applicationCart.some(i=>i.sName===sch.name && i.dName===dept.name);
                
                let btn = inCart 
                    ? `<button class="btn btn-outline-danger btn-sm" onclick="removeFromCartByObj('${sch.name}','${dept.name}')">å–æ¶ˆé¸å¡«</button>`
                    : `<button class="btn btn-outline-primary btn-sm" onclick="addToCart('${sch.name}','${dept.name}')">åŠ å…¥å¿—é¡˜</button>`;
                
                container.innerHTML += `
                    <div class="dept-card px-2 py-2 bg-white">
                        <div class="d-flex justify-content-between">
                            <div>
                                <div class="fw-bold">${dept.name}</div>
                                <div class="text-muted" style="font-size:0.8rem">æª¢: ${reqText} | æ¡: ${wText}</div>
                            </div>
                            <div class="text-end">
                                <div class="mb-1"><span class="traffic-light ${light}"></span><span class="small">${ana.msg}</span></div>
                                ${btn}
                            </div>
                        </div>
                    </div>`;
            });
        }

        function analyzeProbability(dept) {
            for(let k in dept.req) {
                if(playerResults[k].grade < currentStandards[k][dept.req[k]]) return {status:'fail', msg:'æœªé”æ¨™'};
            }
            let myTotalGrade = 0; 
            dept.weight.forEach(w => myTotalGrade += playerResults[w].grade);
            
            if(myTotalGrade >= dept.baseScore) return {status:'safe', msg:'ç©©'};
            if(myTotalGrade >= dept.baseScore - 2) return {status:'risky', msg:'æœ‰æ©Ÿæœƒ'};
            return {status:'fail', msg:'å±éšª'};
        }

        window.addToCart = function(sName, dName) {
            if(applicationCart.length >= 6) { alert("æœ€å¤šé¸å¡« 6 å€‹å¿—é¡˜"); return; }
            let sch = ALL_SCHOOLS_DATA.find(s=>s.name===sName);
            let dept = sch.depts.find(d=>d.name===dName);
            applicationCart.push({sName, dName, dept});
            updateCartUI();
            refreshCurrentSchoolView(sName);
        }

        window.removeFromCartByObj = function(sName, dName) {
            let idx = applicationCart.findIndex(i => i.sName === sName && i.dName === dName);
            if(idx !== -1) {
                applicationCart.splice(idx, 1);
                updateCartUI();
                refreshCurrentSchoolView(sName);
            }
        }

        function refreshCurrentSchoolView(sName) {
            let cur = document.getElementById('selected-school-name').innerText;
            if(cur === sName) {
                let sch = ALL_SCHOOLS_DATA.find(s=>s.name===cur);
                if(sch) selectSchool(ALL_SCHOOLS_DATA.indexOf(sch));
            }
        }

        function updateCartUI() {
            const bar = document.getElementById('application-cart');
            bar.style.display = applicationCart.length>0 ? 'flex':'none';
            document.getElementById('cart-count').innerText = applicationCart.length;
            
            const listDiv = document.getElementById('cart-items');
            listDiv.innerHTML = applicationCart.map((i,idx)=> `
                <div class="cart-item-badge">
                    <span>${i.sName} - ${i.dName}</span>
                    <button type="button" class="btn-close" onclick="remCart(${idx})"></button>
                </div>
            `).join('');
        }

        window.remCart = function(idx) {
            let item = applicationCart[idx];
            applicationCart.splice(idx,1);
            updateCartUI();
            refreshCurrentSchoolView(item.sName);
        }

        window.submitApplication = function() {
            if(applicationCart.length===0) return;
            let html = '<div class="list-group">';
            
            applicationCart.forEach(item => {
                let dept = item.dept;
                let pass = true;
                let reason = "";
                
                for(let k in dept.req) {
                    if(playerResults[k].grade < currentStandards[k][dept.req[k]]) {
                        pass=false; reason=`${SUBJECTS_CONFIG.find(s=>s.id==k).name}æ¨™æœªé”`; break;
                    }
                }
                
                let myTotalGrade = 0;
                dept.weight.forEach(w => myTotalGrade += playerResults[w].grade);
                let admissionCutoff = dept.baseScore + (Math.floor(Math.random()*3) - 1);
                let admit = pass && (myTotalGrade >= admissionCutoff);
                let badge = admit ? '<span class="badge bg-success">éŒ„å–</span>' : '<span class="badge bg-secondary">æœªéŒ„å–</span>';
                let msg = pass 
                    ? (admit ? `ç”„è©¦ç¸½ç´šåˆ† ${myTotalGrade} é”éŒ„å–æ¨™æº– (${admissionCutoff})` : `ç”„è©¦ç¸½ç´šåˆ† ${myTotalGrade} æœªé”éŒ„å–æ¨™æº– (${admissionCutoff})`)
                    : `ç¬¬ä¸€éšæ®µç¯©é¸æœªé€šé (${reason})`;
                
                html += `<div class="list-group-item">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-1">${item.sName} - ${item.dName}</h5>
                        ${badge}
                    </div>
                    <small class="text-muted">${msg}</small>
                </div>`;
            });
            html += '</div>';
            document.getElementById('result-body').innerHTML = html;
            new bootstrap.Modal(document.getElementById('resultModal')).show();
        }

        initGame();
    </script>
</body>
</html>



